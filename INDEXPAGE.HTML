<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanzasPro - Gestión Personal</title>
    
    <!-- Estilos Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel para traducir React en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Mapa de Importaciones -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.300.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        
        /* Scrollbar personalizado */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        
        /* Estilos específicos para inputs de calculadora */
        .calc-input:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Wallet, TrendingUp, TrendingDown, PieChart, Download, Plus, Target, 
            AlertCircle, LayoutDashboard, BarChart3, X, Calendar, ChevronLeft, 
            ChevronRight, Search, Edit2, Trash2, ArrowUpRight, ArrowDownRight, 
            PiggyBank, List, Calculator, Percent, Clock, LogIn, UserPlus, 
            Settings, Save, AlertTriangle, LogOut, ArrowUpDown, Cloud, CheckCircle2,
            Lightbulb, Sparkles, Building2, Car, CreditCard, Banknote
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from 'firebase/auth';
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, updateDoc, serverTimestamp } from 'firebase/firestore';

        // --- CONFIGURACIÓN DE FIREBASE ---
        const localConfig = {
            apiKey: "TU_API_KEY_AQUI",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_PROYECTO.appspot.com",
            messagingSenderId: "TU_SENDER_ID",
            appId: "TU_APP_ID"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : localConfig;
        
        const getSafeAppId = () => {
            if (typeof __app_id !== 'undefined' && __app_id) return __app_id;
            return 'finanzas-pro-local'; 
        };
        const appId = getSafeAppId();

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.warn("Modo Offline: Firebase no configurado.", error);
        }

        // --- UTILIDADES ---
        const formatCurrency = (amount) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
        const formatNumberInput = (val) => val ? new Intl.NumberFormat('es-CO').format(val.replace(/\D/g, "")) : "";
        const parseNumberInput = (val) => val ? parseInt(val.replace(/\./g, ""), 10) : 0;
        const formatDate = (date) => new Intl.DateTimeFormat('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }).format(date);
        const getMonthName = (date) => new Intl.DateTimeFormat('es-ES', { month: 'long', year: 'numeric' }).format(date);

        // --- MANEJO DE DATOS LOCALES ---
        const saveLocal = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        const getLocal = (key) => JSON.parse(localStorage.getItem(key) || '[]');

        // --- COMPONENTES UI ---
        const Button = ({ onClick, children, variant = "primary", className = "", type = "button", disabled = false }) => {
            const base = "font-medium transition-all duration-200 flex items-center justify-center gap-2 rounded-xl active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-slate-900 text-white hover:bg-slate-800 shadow-lg border border-slate-900 px-4 py-2.5 text-sm",
                secondary: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50 shadow-sm px-4 py-2.5 text-sm",
                accent: "bg-emerald-500 text-white hover:bg-emerald-600 shadow-lg border border-emerald-500 px-4 py-2.5 text-sm",
                danger: "bg-rose-50 text-rose-600 border border-rose-100 hover:bg-rose-100 px-4 py-2.5 text-sm"
            };
            return <button type={type} onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`}>{children}</button>;
        };

        const Card = ({ children, className = "", noPadding = false }) => (
            <div className={`bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden ${className}`}>
                <div className={noPadding ? "" : "p-6"}>{children}</div>
            </div>
        );

        const Badge = ({ children, color = "slate" }) => {
            const colors = { slate: "bg-slate-100 text-slate-600", emerald: "bg-emerald-50 text-emerald-700", rose: "bg-rose-50 text-rose-700" };
            return <span className={`px-2.5 py-1 rounded-lg text-xs font-semibold ${colors[color]}`}>{children}</span>;
        };

        const StatCard = ({ title, value, trend, icon: Icon, trendValue, type = "neutral" }) => {
            const styles = {
                neutral: { bg: "bg-slate-50", text: "text-slate-600", valColor: "text-slate-900" },
                success: { bg: "bg-emerald-50", text: "text-emerald-600", valColor: "text-slate-900" },
                danger: { bg: "bg-rose-50", text: "text-rose-600", valColor: "text-slate-900" },
                info: { bg: "bg-blue-50", text: "text-blue-600", valColor: "text-slate-900" }
            };
            const s = styles[type];
            return (
                <Card className="hover:shadow-md transition-shadow">
                    <div className="flex justify-between items-start mb-4">
                        <div className={`p-3 rounded-xl ${s.bg} ${s.text}`}><Icon size={22} /></div>
                        {trendValue && (
                            <div className={`flex items-center text-xs font-semibold px-2 py-1 rounded-full ${trend === 'up' ? 'bg-emerald-50 text-emerald-700' : (trend === 'down' ? 'bg-rose-50 text-rose-700' : 'bg-slate-100 text-slate-600')}`}>
                                {trend === 'up' && <ArrowUpRight size={14} className="mr-1"/>}
                                {trend === 'down' && <ArrowDownRight size={14} className="mr-1"/>}
                                {trendValue}
                            </div>
                        )}
                    </div>
                    <div>
                        <p className="text-slate-500 text-sm font-medium mb-1">{title}</p>
                        <h3 className={`text-2xl font-bold tracking-tight ${s.valColor}`}>{value}</h3>
                    </div>
                </Card>
            );
        };

        const CustomProgressBar = ({ value, max, colorClass }) => {
            const p = Math.min(100, Math.max(0, (value / max) * 100));
            return <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div className={`h-full rounded-full transition-all duration-1000 ${colorClass}`} style={{ width: `${p}%` }} /></div>;
        };

        // --- GRAFICAS ---
        const SimpleBarVisual = ({ income, expense }) => {
            const max = Math.max(income, expense, 1);
            return (
                <div className="flex items-end gap-6 h-40 mt-6 px-8 justify-center">
                    <div className="w-24 flex flex-col items-center gap-3 group">
                        <div className="text-xs font-bold text-emerald-700 bg-emerald-100 px-3 py-1.5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity transform translate-y-2 group-hover:translate-y-0">{formatCurrency(income)}</div>
                        <div style={{height: `${(income/max)*100}%`}} className="w-full bg-gradient-to-t from-emerald-500 to-emerald-400 rounded-t-xl shadow-lg transition-all duration-500"></div>
                        <span className="text-xs font-bold text-slate-600 uppercase">Ingresos</span>
                    </div>
                    <div className="w-24 flex flex-col items-center gap-3 group">
                        <div className="text-xs font-bold text-rose-700 bg-rose-100 px-3 py-1.5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity transform translate-y-2 group-hover:translate-y-0">{formatCurrency(expense)}</div>
                        <div style={{height: `${(expense/max)*100}%`}} className="w-full bg-gradient-to-t from-rose-500 to-rose-400 rounded-t-xl shadow-lg transition-all duration-500"></div>
                        <span className="text-xs font-bold text-slate-600 uppercase">Gastos</span>
                    </div>
                </div>
            );
        };

        const CategoryPieChart = ({ data }) => {
            const total = data.reduce((sum, item) => sum + item.value, 0);
            let currentAngle = 0;
            const COLORS = ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1', '#14B8A6'];
            
            if (total === 0) return <div className="text-slate-400 text-center py-10 text-sm">No hay gastos para mostrar</div>;

            return (
                <div className="flex flex-col md:flex-row items-center justify-around gap-8 py-4">
                    <div className="relative w-48 h-48">
                        <svg viewBox="0 0 100 100" className="w-full h-full transform -rotate-90 drop-shadow-md">
                            {data.map((item, index) => {
                                const sliceAngle = (item.value / total) * 360;
                                const x1 = 50 + 50 * Math.cos(Math.PI * currentAngle / 180);
                                const y1 = 50 + 50 * Math.sin(Math.PI * currentAngle / 180);
                                const x2 = 50 + 50 * Math.cos(Math.PI * (currentAngle + sliceAngle) / 180);
                                const y2 = 50 + 50 * Math.sin(Math.PI * (currentAngle + sliceAngle) / 180);
                                const largeArc = sliceAngle > 180 ? 1 : 0;
                                const path = `M 50 50 L ${x1} ${y1} A 50 50 0 ${largeArc} 1 ${x2} ${y2} Z`;
                                currentAngle += sliceAngle;
                                return <path d={path} fill={COLORS[index % COLORS.length]} key={index} className="hover:opacity-80 transition-opacity cursor-pointer" />;
                            })}
                            <circle cx="50" cy="50" r="35" fill="white" />
                        </svg>
                        <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <span className="text-[10px] font-bold text-slate-400 uppercase">Total</span>
                            <span className="text-sm font-extrabold text-slate-800">{formatCurrency(total).split(',')[0]}</span>
                        </div>
                    </div>
                    <div className="w-full md:w-auto space-y-2 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
                        {data.map((item, index) => (
                            <div key={index} className="flex items-center justify-between gap-6 text-sm p-1.5 hover:bg-slate-50 rounded">
                                <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full" style={{backgroundColor: COLORS[index % COLORS.length]}}></span><span className="text-slate-600 font-medium">{item.name}</span></div>
                                <div className="flex items-center gap-3"><span className="text-slate-400 text-xs">{Math.round((item.value/total)*100)}%</span><span className="font-bold text-slate-800">{formatCurrency(item.value)}</span></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SmartInsight = ({ summary, expensesByCategory }) => {
            const insights = [];
            if (summary.percentSpent > 90) insights.push({ icon: AlertTriangle, color: 'text-rose-600', bg: 'bg-rose-50', title: 'Alerta de Presupuesto', text: 'Has consumido casi todo tu presupuesto. Detén gastos no esenciales.' });
            else if (summary.percentSpent > 75) insights.push({ icon: AlertCircle, color: 'text-amber-600', bg: 'bg-amber-50', title: 'Precaución', text: `Estás al ${Math.round(summary.percentSpent)}% de tu límite mensual. Controla tus gastos.` });
            else insights.push({ icon: CheckCircle2, color: 'text-emerald-600', bg: 'bg-emerald-50', title: 'Buen Camino', text: 'Tu ritmo de gasto es saludable. ¡Sigue así!' });

            if (summary.monthlyBalance < 0) insights.push({ icon: TrendingDown, color: 'text-rose-600', bg: 'bg-rose-50', title: 'Déficit Mensual', text: 'Tus gastos superan tus ingresos este mes. Revisa tus prioridades.' });
            else if (summary.monthlyBalance > 0) insights.push({ icon: PiggyBank, color: 'text-blue-600', bg: 'bg-blue-50', title: 'Oportunidad de Ahorro', text: `Tienes un excedente de ${formatCurrency(summary.monthlyBalance)}. Considera ahorrarlo o invertirlo.` });

            if (expensesByCategory.length > 0) {
                const top = expensesByCategory[0];
                const percent = Math.round((top.value / (summary.expenses || 1)) * 100);
                insights.push({ icon: PieChart, color: 'text-purple-600', bg: 'bg-purple-50', title: 'Mayor Gasto', text: `Tu categoría más alta es "${top.name}" (${percent}% del total). Intenta reducirla un 5%.` });
            }

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {insights.map((insight, idx) => (
                        <div key={idx} className={`p-4 rounded-xl border flex items-start gap-4 ${insight.bg} border-opacity-50 border-slate-200`}>
                            <div className={`p-2 rounded-lg bg-white shadow-sm ${insight.color}`}><insight.icon size={20} /></div>
                            <div><h4 className={`font-bold text-sm ${insight.color}`}>{insight.title}</h4><p className="text-xs text-slate-600 mt-1 leading-relaxed">{insight.text}</p></div>
                        </div>
                    ))}
                </div>
            );
        };

        // --- CALCULADORA PRO (MEJORADA - TEXTO NEGRO) ---
        const LoanCalculator = () => {
            const [amountDisplay, setAmountDisplay] = useState("");
            const [rate, setRate] = useState(22);
            const [months, setMonths] = useState(24);
            const [loanType, setLoanType] = useState('libre');

            const amountValue = parseNumberInput(amountDisplay);

            const loanTypes = [
                { id: 'libre', label: 'Crédito Libre Inversión', icon: Banknote, defaultRate: 22, desc: 'Uso general, sin prenda.' },
                { id: 'vehiculo', label: 'Crédito Vehículo', icon: Car, defaultRate: 18, desc: 'Con prenda sobre el vehículo.' },
                { id: 'vivienda', label: 'Vivienda (Hipotecario)', icon: Building2, defaultRate: 14, desc: 'Compra de vivienda (VIS/No VIS).' },
                { id: 'libranza', label: 'Crédito Libranza', icon: Wallet, defaultRate: 16, desc: 'Descuento directo de nómina.' },
                { id: 'tarjeta', label: 'Tarjeta de Crédito', icon: CreditCard, defaultRate: 28, desc: 'Compras diferidas a cuotas.' },
            ];

            const handleTypeChange = (e) => {
                const type = e.target.value;
                setLoanType(type);
                const selected = loanTypes.find(t => t.id === type);
                if(selected) setRate(selected.defaultRate);
            };

            const monthlyPayment = (() => {
                if (!amountValue || !months) return 0;
                const r = (rate / 100) / 12;
                if (r === 0) return amountValue / months;
                return (amountValue * r * Math.pow(1 + r, months)) / (Math.pow(1 + r, months) - 1);
            })();
            const totalPayment = monthlyPayment * months;
            const totalInterest = totalPayment - amountValue;

            return (
                <div className="space-y-8 animate-in">
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* Panel de Configuración */}
                        <Card className="lg:col-span-2 p-8 shadow-md border-slate-200">
                            <h3 className="text-xl font-bold text-slate-900 mb-6 flex items-center gap-2">
                                <Settings className="text-slate-500" size={24}/> Configura tu Crédito
                            </h3>
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-2">Tipo de Préstamo (Colombia)</label>
                                    <div className="relative">
                                        <select 
                                            value={loanType} 
                                            onChange={handleTypeChange}
                                            className="w-full p-4 pl-12 bg-slate-50 border border-slate-300 rounded-xl font-semibold text-slate-800 focus:ring-2 focus:ring-slate-900 outline-none appearance-none cursor-pointer transition-all hover:bg-slate-100"
                                        >
                                            {loanTypes.map(t => <option key={t.id} value={t.id}>{t.label}</option>)}
                                        </select>
                                        <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none">
                                            {loanType === 'libre' && <Banknote size={20}/>}
                                            {loanType === 'vehiculo' && <Car size={20}/>}
                                            {loanType === 'vivienda' && <Building2 size={20}/>}
                                            {loanType === 'libranza' && <Wallet size={20}/>}
                                            {loanType === 'tarjeta' && <CreditCard size={20}/>}
                                        </div>
                                        <div className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">▼</div>
                                    </div>
                                    <p className="text-xs text-slate-500 mt-2 ml-1">
                                        {loanTypes.find(t => t.id === loanType)?.desc} *Tasa sugerida, ajustable.
                                    </p>
                                </div>

                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-2">Monto a Solicitar</label>
                                    <div className="relative calc-input rounded-xl overflow-hidden bg-white border border-slate-300">
                                        <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-lg">$</span>
                                        <input 
                                            type="text" 
                                            value={amountDisplay} 
                                            onChange={e => setAmountDisplay(formatNumberInput(e.target.value))} 
                                            placeholder="Ej: 10.000.000" 
                                            className="w-full pl-10 pr-4 py-4 text-xl font-bold text-slate-900 outline-none placeholder-slate-300"
                                        />
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-2">Tasa Efectiva Anual (%)</label>
                                        <div className="relative calc-input rounded-xl overflow-hidden bg-white border border-slate-300">
                                            <input 
                                                type="number" 
                                                value={rate} 
                                                onChange={e => setRate(Number(e.target.value))} 
                                                className="w-full pl-4 pr-10 py-4 text-lg font-bold text-slate-900 outline-none"
                                            />
                                            <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-2">Plazo (Meses)</label>
                                        <div className="relative calc-input rounded-xl overflow-hidden bg-white border border-slate-300">
                                            <input 
                                                type="number" 
                                                value={months} 
                                                onChange={e => setMonths(Number(e.target.value))} 
                                                className="w-full pl-4 pr-10 py-4 text-lg font-bold text-slate-900 outline-none"
                                            />
                                            <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"><Clock size={18}/></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </Card>

                        {/* Panel de Resultados PRO - FONDO CLARO CON TEXTO NEGRO */}
                        <div className="lg:col-span-1">
                            <div className="sticky top-24">
                                <Card className="bg-white text-slate-900 shadow-xl overflow-hidden border border-slate-200 h-full flex flex-col justify-between relative">
                                    {/* Fondo decorativo sutil */}
                                    <div className="absolute top-0 right-0 w-64 h-64 bg-slate-50 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                                    
                                    <div className="p-8 relative z-10">
                                        <h3 className="text-[#000000] font-bold mb-1 uppercase tracking-wider text-xs">Cuota Mensual Estimada</h3>
                                        <div className="text-4xl md:text-5xl font-extrabold text-[#000000] mb-8 tracking-tight">
                                            {monthlyPayment > 0 ? formatCurrency(monthlyPayment) : "$0"}
                                        </div>

                                        <div className="space-y-4">
                                            <div className="flex justify-between items-center text-sm border-b border-slate-100 pb-3">
                                                <span className="text-slate-600 font-semibold">Total Capital</span>
                                                <span className="font-bold text-slate-900">{formatCurrency(amountValue)}</span>
                                            </div>
                                            <div className="flex justify-between items-center text-sm border-b border-slate-100 pb-3">
                                                <span className="text-slate-600 font-semibold">Total Intereses</span>
                                                <span className="font-bold text-rose-600">{formatCurrency(totalInterest)}</span>
                                            </div>
                                            <div className="flex justify-between items-center text-base pt-2">
                                                <span className="text-slate-800 font-extrabold">Total a Pagar</span>
                                                <span className="font-extrabold text-[#000000] text-lg">{formatCurrency(totalPayment)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-slate-50 p-4 text-center text-xs text-slate-500 border-t border-slate-200">
                                        * Valores aproximados. No incluye seguros ni costos adicionales.
                                    </div>
                                </Card>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [transactions, setTransactions] = useState([]);
            const [settings, setSettings] = useState({ budgetLimit: 0, initialBalance: 0, userName: '', savingsGoal: { name: '', target: 0, current: 0 } });
            
            const [currentTab, setCurrentTab] = useState('dashboard');
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [searchTerm, setSearchTerm] = useState('');
            const [categoryFilter, setCategoryFilter] = useState('Todas');
            const [sortOrder, setSortOrder] = useState('desc');
            const [filterDate, setFilterDate] = useState('');
            const [isSaving, setIsSaving] = useState(false);
            
            const [modalMode, setModalMode] = useState('create');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [deleteConfirmation, setDeleteConfirmation] = useState(null);
            const [authTab, setAuthTab] = useState('register');
            const [formData, setFormData] = useState({ id: null, type: 'expense', amount: '', category: 'Alimentación', description: '', date: new Date().toISOString().slice(0,10) });
            const [loginData, setLoginData] = useState({ name: '', email: '' });
            const [settingsForm, setSettingsForm] = useState({ budgetLimit: '', initialBalance: '' });

            // Inicialización Auth
            useEffect(() => {
                const init = async () => {
                    try {
                        if(auth) {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                            else await signInAnonymously(auth);
                        } else {
                            setUser({ uid: 'local-user' });
                            setLoading(false);
                        }
                    } catch(e) { console.error(e); setUser({ uid: 'local-user' }); setLoading(false); }
                };
                init();
                if(auth) return onAuthStateChanged(auth, u => { setUser(u); setLoading(false); });
            }, []);

            // Sincronización Datos
            useEffect(() => {
                if (!user) return;
                
                const localTrans = getLocal('transactions');
                if(localTrans.length > 0) setTransactions(localTrans);
                
                const localSettings = JSON.parse(localStorage.getItem('settings') || '{}');
                if(localSettings.userName) setSettings(prev => ({...prev, ...localSettings}));

                if (db && auth && user.uid !== 'local-user') {
                    try {
                        const safeAppId = appId || 'finanzas-pro-local';
                        const unsubT = onSnapshot(query(collection(db, 'artifacts', safeAppId, 'users', user.uid, 'transactions')), snap => {
                            const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            setTransactions(data);
                            saveLocal('transactions', data);
                        });
                        const unsubS = onSnapshot(query(collection(db, 'artifacts', safeAppId, 'users', user.uid, 'settings')), snap => {
                            if (!snap.empty) {
                                const s = snap.docs[0].data();
                                setSettings(prev => ({ ...prev, ...s }));
                                saveLocal('settings', s);
                            }
                        });
                        return () => { unsubT(); unsubS(); };
                    } catch(e) { console.error("Error sync firebase", e); }
                }
            }, [user]);

            // Lógica filtrado
            const filteredData = useMemo(() => {
                let filtered = transactions.filter(t => {
                    const tDate = t.dateStr ? new Date(t.dateStr) : new Date(t.createdAt?.seconds * 1000 || Date.now());
                    const isSameMonth = !filterDate && tDate.getMonth() === selectedDate.getMonth() && tDate.getFullYear() === selectedDate.getFullYear();
                    const isExactDate = filterDate && t.dateStr === filterDate;
                    const matchesSearch = t.description?.toLowerCase().includes(searchTerm.toLowerCase()) || t.category?.toLowerCase().includes(searchTerm.toLowerCase());
                    return (isSameMonth || isExactDate) && matchesSearch && (categoryFilter === 'Todas' || t.category === categoryFilter);
                });
                filtered.sort((a, b) => {
                    const dateA = new Date(a.dateStr);
                    const dateB = new Date(b.dateStr);
                    return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
                });
                return filtered;
            }, [transactions, selectedDate, searchTerm, categoryFilter, sortOrder, filterDate]);

            // Lógica Resumen
            const summary = useMemo(() => {
                const income = filteredData.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
                const expenses = filteredData.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
                const monthlyBalance = income - expenses;
                const remaining = settings.budgetLimit > 0 ? settings.budgetLimit - expenses : 0;
                const percentSpent = settings.budgetLimit > 0 ? (expenses / settings.budgetLimit) * 100 : 0;
                const totalBalance = (settings.initialBalance || 0) + income - expenses;
                
                const trendIncome = income > 0 ? 'up' : 'neutral';
                const trendExpense = expenses > (settings.budgetLimit * 0.7) ? 'up' : 'down';
                
                return { income, expenses, monthlyBalance, remaining, percentSpent, totalBalance, trendIncome, trendExpense };
            }, [filteredData, settings]);

            const expensesByCategory = useMemo(() => {
                const grouped = filteredData.filter(t => t.type === 'expense').reduce((acc, curr) => {
                    acc[curr.category] = (acc[curr.category] || 0) + curr.amount;
                    return acc;
                }, {});
                return Object.keys(grouped).map(key => ({ name: key, value: grouped[key] })).sort((a, b) => b.value - a.value);
            }, [filteredData]);

            // Generador de Recomendación
            const getMainRecommendation = () => {
                if (summary.percentSpent > 85) return { icon: AlertTriangle, color: 'text-rose-700', bg: 'bg-rose-50', text: '¡Cuidado! Estás por agotar tu presupuesto.' };
                if (summary.monthlyBalance < 0) return { icon: TrendingDown, color: 'text-amber-700', bg: 'bg-amber-50', text: 'Tus gastos superan tus ingresos. Revisa tus salidas.' };
                if (summary.percentSpent < 50 && summary.expenses > 0) return { icon: CheckCircle2, color: 'text-emerald-700', bg: 'bg-emerald-50', text: 'Excelente gestión. Considera destinar el excedente a ahorros.' };
                return { icon: Lightbulb, color: 'text-blue-700', bg: 'bg-blue-50', text: 'Registra todos tus movimientos para un mejor control.' };
            };
            const mainRec = getMainRecommendation();

            // Handlers
            const handleRegister = async (e) => {
                e.preventDefault();
                if (!loginData.name) return;
                const newSettings = { userName: loginData.name, email: loginData.email, initialBalance: 0, budgetLimit: 0, createdAt: new Date() };
                setSettings(prev => ({...prev, ...newSettings}));
                saveLocal('settings', newSettings);
                if (db && auth && user.uid !== 'local-user') {
                    try { await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'settings'), newSettings); } catch(e) { console.warn("Registro solo local"); }
                }
            };

            const handleLogout = async () => {
                if(window.confirm('¿Cerrar sesión?')) {
                    if(auth) await signOut(auth);
                    localStorage.clear();
                    window.location.reload();
                }
            };

            const handleSaveAll = () => {
                setIsSaving(true);
                saveLocal('transactions', transactions);
                saveLocal('settings', settings);
                setTimeout(() => { setIsSaving(false); alert("¡Datos guardados correctamente!"); }, 800);
            };

            const requestDelete = (e, t) => { e.stopPropagation(); setDeleteConfirmation(t); };
            
            const confirmDelete = async () => {
                if (!deleteConfirmation) return;
                const updatedTransactions = transactions.filter(t => t.id !== deleteConfirmation.id);
                setTransactions(updatedTransactions);
                saveLocal('transactions', updatedTransactions);
                setDeleteConfirmation(null);
                if (db && user && user.uid !== 'local-user') {
                    try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'transactions', deleteConfirmation.id)); } catch (error) { console.warn("Borrado solo local"); }
                }
            };

            const handleSaveTransaction = async (e) => {
                e.preventDefault();
                const newId = formData.id || Date.now().toString();
                const payload = { ...formData, id: newId, amount: parseFloat(formData.amount), dateStr: formData.date, updatedAt: new Date() };
                let newTransList;
                if (modalMode === 'create') {
                    newTransList = [...transactions, payload];
                } else {
                    newTransList = transactions.map(t => t.id === formData.id ? payload : t);
                }
                setTransactions(newTransList);
                saveLocal('transactions', newTransList);
                setIsModalOpen(false);
                if(db && user && user.uid !== 'local-user') {
                    const safeAppId = appId || 'finanzas-pro-local';
                    try {
                        if (modalMode === 'create') {
                            const { id, ...dataToSave } = payload; 
                            await addDoc(collection(db, 'artifacts', safeAppId, 'users', user.uid, 'transactions'), { ...dataToSave, createdAt: serverTimestamp() });
                        } else {
                            await updateDoc(doc(db, 'artifacts', safeAppId, 'users', user.uid, 'transactions', formData.id), payload);
                        }
                    } catch(e) { console.warn("Guardado solo local"); }
                }
            };

            const updateSettings = async () => {
                const newVals = { budgetLimit: parseNumberInput(settingsForm.budgetLimit), initialBalance: parseNumberInput(settingsForm.initialBalance) };
                setSettings(prev => ({...prev, ...newVals}));
                saveLocal('settings', {...settings, ...newVals});
                setIsModalOpen(false);
            };

            const exportToExcel = () => {
                const dateStr = selectedDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                const tableHTML = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                    <head><meta http-equiv="content-type" content="text/plain; charset=UTF-8"/>
                    <style>
                        body { font-family: 'Segoe UI', sans-serif; }
                        table { border-collapse: collapse; width: 100%; }
                        .main-title { background-color: #1e3a8a; color: #fff; font-size: 24px; font-weight: bold; text-align: center; padding: 20px; border: 2px solid #000; }
                        th { background-color: #2563eb; color: #fff; font-weight: bold; text-align: center; padding: 12px; border: 1px solid #000; }
                        td { padding: 10px; border: 1px solid #000; vertical-align: middle; }
                        tr:nth-child(even) { background-color: #eff6ff; }
                        .amount-income { color: #166534; font-weight: bold; }
                        .amount-expense { color: #991b1b; font-weight: bold; }
                        .total-row-label { background-color: #1e3a8a; color: #fff; font-weight: bold; text-align: right; border: 1px solid #000; }
                        .total-row-value { background-color: #fbbf24; color: #000; font-weight: bold; text-align: right; border: 1px solid #000; font-size: 16px; }
                    </style></head>
                    <body>
                        <table>
                            <thead><tr><th colspan="5" class="main-title">REPORTE FINANCIERO - ${dateStr.toUpperCase()}</th></tr>
                            <tr><th>FECHA</th><th>TIPO</th><th>CATEGORÍA</th><th>DESCRIPCIÓN</th><th>MONTO</th></tr></thead>
                            <tbody>
                                ${filteredData.map(t => `<tr><td style="text-align:center;">${t.dateStr}</td><td style="text-align:center;">${t.type === 'income' ? 'Ingreso' : 'Egreso'}</td><td>${t.category}</td><td>${t.description || '-'}</td><td style="text-align:right;" class="${t.type === 'income' ? 'amount-income' : 'amount-expense'}">${t.amount}</td></tr>`).join('')}
                                <tr><td colspan="4" class="total-row-label">BALANCE TOTAL:</td><td class="total-row-value">${summary.monthlyBalance}</td></tr>
                            </tbody>
                        </table>
                    </body></html>`;
                const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `Reporte_${getMonthName(selectedDate)}.xls`;
                link.click();
            };

            const changeMonth = (offset) => { const d = new Date(selectedDate); d.setMonth(d.getMonth() + offset); setSelectedDate(d); setFilterDate(''); };

            // --- RENDER ---
            if (loading) return <div className="h-screen flex items-center justify-center bg-slate-50 text-slate-500 font-medium">Cargando FinanzasPro...</div>;

            if (!settings.userName && user) return (
                <div className="h-screen bg-[#0f172a] flex items-center justify-center p-4">
                    <Card className="w-full max-w-md p-8">
                        <h1 className="text-3xl font-bold text-center mb-6">Bienvenido</h1>
                        <div className="flex bg-slate-100 p-1 rounded-xl mb-6">
                            <button onClick={() => setAuthTab('login')} className={`flex-1 py-2 rounded-lg text-sm font-bold ${authTab === 'login' ? 'bg-white shadow' : 'text-slate-500'}`}>Iniciar</button>
                            <button onClick={() => setAuthTab('register')} className={`flex-1 py-2 rounded-lg text-sm font-bold ${authTab === 'register' ? 'bg-white shadow' : 'text-slate-500'}`}>Registrar</button>
                        </div>
                        {authTab === 'register' ? (
                            <form onSubmit={handleRegister} className="space-y-4">
                                <input className="w-full p-3 border rounded-xl" value={loginData.name} onChange={e => setLoginData({...loginData, name: e.target.value})} placeholder="Tu nombre" required />
                                <Button type="submit" className="w-full">Crear Cuenta</Button>
                            </form>
                        ) : (
                            <Button onClick={() => window.location.reload()} className="w-full" variant="secondary">Entrar como invitado</Button>
                        )}
                    </Card>
                </div>
            );

            return (
                <div className="min-h-screen bg-[#f8fafc] pb-24 md:pb-10 font-sans text-slate-900">
                    <header className="sticky top-0 z-30 bg-white/80 backdrop-blur-lg border-b border-slate-200 p-4">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3 font-bold text-lg"><div className="bg-slate-900 text-white p-1.5 rounded-lg"><Wallet size={18}/></div>FinanzasPro</div>
                            <nav className="hidden md:flex bg-slate-100 p-1 rounded-xl">
                                {[{id:'dashboard', icon:LayoutDashboard, label:'Panel'}, {id:'transactions', icon:List, label:'Movimientos'}, {id:'reports', icon:BarChart3, label:'Análisis'}, {id:'calculator', icon:Calculator, label:'Calc'}].map(t => (
                                    <button key={t.id} onClick={() => setCurrentTab(t.id)} className={`flex gap-2 px-4 py-1.5 rounded-lg text-sm font-medium transition-all ${currentTab===t.id ? 'bg-white shadow text-slate-900' : 'text-slate-500 hover:text-slate-800'}`}><t.icon size={16}/> {t.label}</button>
                                ))}
                            </nav>
                            <div className="flex items-center gap-3">
                                <button onClick={handleSaveAll} disabled={isSaving} className="flex items-center gap-2 px-3 py-1.5 bg-emerald-100 text-emerald-700 rounded-lg text-xs font-bold hover:bg-emerald-200">
                                    {isSaving ? "Guardando..." : <><Cloud size={16}/> Guardar Todo</>}
                                </button>
                                <div className="flex items-center bg-white border rounded-lg p-1">
                                    <button onClick={() => changeMonth(-1)} className="p-1 text-slate-500 hover:bg-slate-50"><ChevronLeft size={16}/></button>
                                    <span className="text-xs font-bold px-2 uppercase min-w-[80px] text-center">{getMonthName(selectedDate)}</span>
                                    <button onClick={() => changeMonth(1)} className="p-1 text-slate-500 hover:bg-slate-50"><ChevronRight size={16}/></button>
                                </div>
                                <button onClick={handleLogout} className="p-2 text-slate-400 hover:text-rose-600 bg-slate-50 rounded-lg" title="Cerrar Sesión"><LogOut size={18}/></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 md:p-8 animate-in">
                        {currentTab === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <StatCard title="Flujo Mensual" value={formatCurrency(summary.monthlyBalance)} icon={TrendingUp} type="info" trendValue={summary.trendIncome === 'up' ? '+ Ingresos' : 'Estable'} trend={summary.trendIncome}/>
                                    <StatCard title="Gastos" value={formatCurrency(summary.expenses)} icon={TrendingDown} type="danger" trendValue={summary.trendExpense === 'up' ? '▲ Alto' : '▼ Controlado'} trend={summary.trendExpense}/>
                                    <StatCard title="Saldo Total" value={formatCurrency(summary.totalBalance)} icon={Wallet} type="success" trend="up"/>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <div className="lg:col-span-2 space-y-4">
                                        
                                        {/* TARJETA DE RECOMENDACIÓN INTELIGENTE (NUEVO) */}
                                        <div className={`p-4 rounded-xl border ${mainRec.bg} border-opacity-50 flex items-start gap-4 mb-4`}>
                                            <div className={`p-2 bg-white rounded-lg shadow-sm ${mainRec.color}`}><mainRec.icon size={20}/></div>
                                            <div>
                                                <h3 className={`font-bold text-sm ${mainRec.color}`}>Consejo del Día</h3>
                                                <p className="text-sm text-slate-700 leading-snug mt-1">{mainRec.text}</p>
                                            </div>
                                        </div>

                                        <div className="flex justify-between items-center"><h3 className="font-bold text-lg">Reciente</h3><Button variant="secondary" size="small" onClick={() => setCurrentTab('transactions')}>Ver Todo</Button></div>
                                        {filteredData.slice(0, 5).map(t => (
                                            <Card key={t.id} noPadding className="flex items-center p-4 cursor-pointer hover:bg-slate-50" onClick={() => { setFormData({...t, date: t.dateStr}); setModalMode('edit'); setIsModalOpen(true); }}>
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${t.type==='income'?'bg-emerald-100 text-emerald-600':'bg-rose-50 text-rose-600'}`}>{t.type==='income'?<ArrowDownRight size={20}/>:<ArrowUpRight size={20}/>}</div>
                                                <div className="ml-4 flex-1"><p className="font-bold text-sm">{t.description || 'Sin descripción'}</p><p className="text-xs text-slate-500">{t.category} • {formatDate(new Date(t.dateStr))}</p></div>
                                                <div className={`font-bold ${t.type==='income'?'text-emerald-600':'text-slate-900'}`}>{t.type==='income'?'+':'-'}{formatCurrency(t.amount)}</div>
                                            </Card>
                                        ))}
                                    </div>
                                    <div className="space-y-6">
                                        <Card className="bg-white text-black relative overflow-hidden">
                                            <div className="absolute top-0 right-0 w-32 h-32 bg-emerald-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                                            <div className="relative z-10">
                                                <div className="flex items-center gap-2 mb-4"><Target className="text-emerald-600"/> <h3 className="font-bold text-lg text-black">Tu Presupuesto</h3></div>
                                                <div className="flex justify-between text-sm mb-2"><span className="font-medium">Gastado</span><span className="font-bold">{Math.round(summary.percentSpent)}%</span></div>
                                                <CustomProgressBar value={summary.expenses} max={settings.budgetLimit || 1} colorClass={summary.percentSpent>85?"bg-rose-500":"bg-emerald-500"}/>
                                                {summary.percentSpent >= 85 && <div className="mt-4 p-3 bg-rose-50 border border-rose-200 rounded-xl flex items-center gap-3"><AlertTriangle className="text-rose-600"/><p className="text-xs text-rose-700 font-bold">¡Atención! Has consumido casi todo tu presupuesto.</p></div>}
                                                <div className="flex justify-between items-end mt-4 pt-4 border-t"><div className="text-black"><p className="text-xs font-bold uppercase">Disponible</p><p className="text-2xl font-bold">{formatCurrency(summary.remaining)}</p></div><Button variant="secondary" onClick={() => { setSettingsForm({budgetLimit: formatNumberInput(String(settings.budgetLimit)), initialBalance: formatNumberInput(String(settings.initialBalance))}); setModalMode('settings'); setIsModalOpen(true); }}>Ajustar</Button></div>
                                            </div>
                                        </Card>
                                    </div>
                                </div>
                            </div>
                        )}

                        {currentTab === 'transactions' && (
                            <div className="space-y-6">
                                <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                    <h2 className="text-2xl font-bold">Historial</h2>
                                    <div className="flex gap-2 w-full md:w-auto items-center">
                                        <div className="relative"><input type="date" value={filterDate} onChange={(e) => setFilterDate(e.target.value)} className="border rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-slate-900" title="Filtrar fecha exacta"/>{filterDate && <button onClick={() => setFilterDate('')} className="absolute -right-2 -top-2 bg-slate-900 text-white rounded-full p-0.5"><X size={12}/></button>}</div>
                                        <div className="relative flex-1"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16}/><input className="w-full border rounded-xl pl-10 pr-4 py-2 text-sm outline-none focus:ring-2 focus:ring-slate-900" placeholder="Buscar..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)}/></div>
                                        <Button variant="secondary" onClick={exportToExcel}><Download size={16}/> Exportar</Button>
                                    </div>
                                </div>
                                <Card noPadding className="overflow-hidden">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-slate-50 text-slate-500 font-semibold border-b">
                                                <tr><th className="p-4 pl-6">Concepto</th><th>Categoría</th><th className="p-4 cursor-pointer hover:bg-slate-100 flex items-center gap-1" onClick={() => setSortOrder(p => p === 'asc' ? 'desc' : 'asc')}>Fecha <ArrowUpDown size={14}/></th><th className="p-4 text-right">Monto</th><th className="p-4 text-center">Acciones</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {filteredData.map(t => (
                                                    <tr key={t.id} className="hover:bg-slate-50">
                                                        <td className="p-4 pl-6"><p className="font-bold text-slate-900">{t.description}</p></td>
                                                        <td className="p-4"><Badge color={t.type==='income'?'emerald':'slate'}>{t.category}</Badge></td>
                                                        <td className="p-4 text-slate-500">{formatDate(new Date(t.dateStr))}</td>
                                                        <td className={`p-4 text-right font-bold ${t.type==='income'?'text-emerald-600':'text-slate-900'}`}>{t.type==='income'?'+':'-'}{formatCurrency(t.amount)}</td>
                                                        <td className="p-4 text-center"><div className="flex justify-center gap-2">
                                                            <button onClick={(e) => { e.stopPropagation(); setFormData({...t, date: t.dateStr}); setModalMode('edit'); setIsModalOpen(true); }} className="p-2 bg-slate-100 hover:bg-slate-200 rounded text-slate-600"><Edit2 size={16}/></button>
                                                            <button onClick={(e) => requestDelete(e, t)} className="p-2 bg-rose-50 hover:bg-rose-100 rounded text-rose-600"><Trash2 size={16}/></button>
                                                        </div></td>
                                                    </tr>
                                                ))}
                                                {filteredData.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-slate-400">Sin resultados</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                </Card>
                            </div>
                        )}

                        {currentTab === 'reports' && (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold">Análisis</h2>
                                
                                {/* SECCIÓN DE RECOMENDACIONES INTELIGENTES (NUEVO) */}
                                <div className="mb-6">
                                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-slate-800"><Sparkles className="text-amber-500" size={20}/> Insights Inteligentes</h3>
                                    <SmartInsight summary={summary} expensesByCategory={expensesByCategory} />
                                </div>

                                <div className="grid lg:grid-cols-2 gap-6">
                                    <Card className="p-6"><h3 className="font-bold mb-4 flex gap-2"><PieChart className="text-purple-500"/> Distribución</h3><CategoryPieChart data={expensesByCategory}/></Card>
                                    <Card className="p-6"><h3 className="font-bold mb-4 flex gap-2"><BarChart3 className="text-blue-500"/> Flujo de Caja</h3><SimpleBarVisual income={summary.income} expense={summary.expenses}/></Card>
                                </div>
                            </div>
                        )}

                        {currentTab === 'calculator' && (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-slate-900">Calculadora de Préstamos</h2>
                                <LoanCalculator/>
                            </div>
                        )}
                    </main>

                    <div className="fixed bottom-8 right-8 z-40">
                        <button onClick={() => { setFormData({id:null, type:'expense', amount:'', category:'Alimentación', description:'', date:new Date().toISOString().slice(0,10)}); setModalMode('create'); setIsModalOpen(true); }} className="bg-slate-900 hover:bg-slate-800 text-white p-4 rounded-full shadow-2xl transition-transform hover:scale-105 active:scale-95"><Plus size={24}/></button>
                    </div>

                    {/* MODAL PRINCIPAL */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in">
                            <Card className="w-full max-w-md shadow-2xl">
                                <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold">{modalMode==='settings'?'Configuración':(modalMode==='create'?'Nuevo Movimiento':'Editar')}</h2><button onClick={() => setIsModalOpen(false)} className="p-2 hover:bg-slate-100 rounded-full"><X size={20}/></button></div>
                                {modalMode === 'settings' ? (
                                    <form onSubmit={e => { e.preventDefault(); updateSettings(); }} className="space-y-6">
                                        <div><label className="block text-xs font-bold mb-2 uppercase">Saldo Inicial</label><input className="w-full p-3 bg-slate-100 border rounded-xl font-bold text-lg text-slate-900" value={settingsForm.initialBalance} onChange={e => setSettingsForm({...settingsForm, initialBalance: formatNumberInput(e.target.value)})}/></div>
                                        <div><label className="block text-xs font-bold mb-2 uppercase">Tope Mensual</label><input className="w-full p-3 bg-slate-100 border rounded-xl font-bold text-lg text-slate-900" value={settingsForm.budgetLimit} onChange={e => setSettingsForm({...settingsForm, budgetLimit: formatNumberInput(e.target.value)})}/></div>
                                        <div className="flex gap-3 pt-2"><Button variant="secondary" onClick={() => setIsModalOpen(false)} className="flex-1">Cancelar</Button><Button type="submit" className="flex-1">Guardar</Button></div>
                                    </form>
                                ) : (
                                    <form onSubmit={handleSaveTransaction} className="space-y-4">
                                        <div className="flex bg-slate-100 p-1 rounded-xl"><button type="button" onClick={() => setFormData({...formData, type:'income'})} className={`flex-1 py-2 rounded-lg text-sm font-bold ${formData.type==='income'?'bg-white text-emerald-600 shadow':'text-slate-500'}`}>Ingreso</button><button type="button" onClick={() => setFormData({...formData, type:'expense'})} className={`flex-1 py-2 rounded-lg text-sm font-bold ${formData.type==='expense'?'bg-white text-rose-600 shadow':'text-slate-500'}`}>Gasto</button></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">Monto</label><input type="number" required className="w-full p-3 border rounded-xl font-bold text-lg" placeholder="0" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})}/></div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">Categoría</label><select className="w-full p-3 border rounded-xl bg-white" value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})}>{(formData.type==='income'?['Salario','Ventas','Ahorros','Inversión','Otro']:['Alimentación','Transporte','Vivienda','Ocio','Salud','Servicios','Suscripciones','Otro']).map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">Fecha</label><input type="date" required className="w-full p-3 border rounded-xl" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})}/></div>
                                        </div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">Descripción</label><input className="w-full p-3 border rounded-xl" placeholder="Ej. Cena" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})}/></div>
                                        <div className="flex gap-3 pt-4"><Button variant="secondary" onClick={() => setIsModalOpen(false)} className="flex-1">Cancelar</Button><Button type="submit" variant={formData.type==='income'?'accent':'primary'} className="flex-1">Guardar</Button></div>
                                    </form>
                                )}
                            </Card>
                        </div>
                    )}

                    {/* MODAL CONFIRMACIÓN BORRAR */}
                    {deleteConfirmation && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in">
                            <Card className="w-full max-w-sm p-6 text-center">
                                <div className="w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-4"><Trash2 className="text-rose-600" size={24}/></div>
                                <h3 className="text-lg font-bold mb-2">¿Eliminar transacción?</h3>
                                <p className="text-sm text-slate-500 mb-6">Se borrará "{deleteConfirmation.description}". No se puede deshacer.</p>
                                <div className="flex gap-3"><Button variant="secondary" onClick={() => setDeleteConfirmation(null)} className="flex-1">Cancelar</Button><Button variant="danger" onClick={confirmDelete} className="flex-1">Sí, Eliminar</Button></div>
                            </Card>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // 1. Aquí pegas la configuración que copiaste en el Paso 2
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_AUTH_DOMAIN",
    projectId: "TU_PROJECT_ID",
    // ... el resto de tus datos
  };

  // 2. Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // 3. Función para enviar datos (Ejemplo: un formulario)
  window.enviarDatos = async (nombreUser, correoUser) => {
    try {
      const docRef = await addDoc(collection(db, "contactos"), {
        nombre: nombreUser,
        email: correoUser,
        fecha: new Date()
      });
      alert("¡Datos guardados con éxito!");
    } catch (e) {
      console.error("Error al guardar: ", e);
    }
  }
</script>

<button onclick="enviarDatos('Juan Perez', 'juan@correo.com')">
  Enviar datos de prueba
</button>